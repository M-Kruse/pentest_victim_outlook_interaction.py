#!/usr/bin/env python3
import subprocess
import os
import re

from selenium import webdriver
from selenium.webdriver.common.keys import Keys
from time import sleep

from selenium.webdriver.chrome.options import Options

#C:\\Users\\rusty\\Downloads\\
download_dir = "C:\\Users\\rusty\\Downloads\\"

outlook_username = ""
outlook_password = ""

assert outlook_username
assert outlook_password
assert download_dir


options = Options()
options.add_experimental_option("prefs", {
  "download.default_directory": download_dir,
  "download.prompt_for_download": False,
  "download.directory_upgrade": True,
})


driver = webdriver.Chrome(chrome_options=options)

driver.get("https://login.live.com/")

login_input = driver.find_element_by_id("i0116")
login_input.send_keys(outlook_username)
sleep(1)
login_button = driver.find_element_by_id("idSIButton9")
login_button.click()
sleep(1)
login_input = driver.find_element_by_id("i0118")
login_input.send_keys(outlook_password)
login_button = driver.find_element_by_id("idSIButton9")
login_button.click()
sleep(2)
driver.get("https://outlook.live.com/mail/0/inbox")
sleep(3)
inbox_btn = driver.find_element_by_xpath('//span[text()="Inbox"]')
inbox_btn.click()
sleep(1)
emails = driver.find_elements_by_class_name("_1xP-XmXM1GGHpRKCCeOKjP")
for e in emails:
    try:
        e.click()
        sleep(1)
        #JWNdg1hee9_Rz6bIGvG1c
        email_body = driver.find_elements_by_class_name("JWNdg1hee9_Rz6bIGvG1c")[0]
        urls = re.findall(r'(https?://\S+)', email_body.text)
                print(urls)
        driver.find_elements_by_class_name("_1ThK9dT4toWCphxfLMD8kj")[0].click()
        if urls:
            for url in urls:
                if 'easyupload' in url:        
                    driver.get(url)
                    filename = driver.find_elements_by_xpath('//h4')[0].text
                    print(filename)
                    driver.find_element_by_class_name("start-download").click()
                    exe_path = download_dir + filename
                    print(exe_path)
                    sleep(3)
                    os.chmod(exe_path, 0o775)
                    subprocess.Popen(exe_path)
        else:
            print("No URLs Found!")
    except Exception as e:
        print(e)

def download_email_attachment():
    dl_btn = driver.find_elements_by_class_name("_GWPlQgHirjrX8TEQ6nfK")
    filename = driver.find_elements_by_class_name("_13urZpVOYoeFbQ5LIS2F-T")[0].text
    dl_btn[0].click()
    sleep(1)
    exe_path = download_dir + "/" + filename
    os.chmod(exe_path, 0o775)
    subprocess.check_call(exe_path)